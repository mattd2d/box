<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMOBOX - Dark Unified Phase</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; color: #fff; }

        /* 系统重置按钮 */
        #global-reset {
            position: fixed; top: 25px; right: 25px; z-index: 200000;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.3); padding: 6px 15px; border-radius: 12px;
            font-size: 9px; letter-spacing: 1px; cursor: pointer; transition: 0.3s;
        }
        #global-reset:hover { background: #ff4d4d; color: #fff; }

        /* 引导遮罩 */
        #guide-mask {
            position: fixed; inset: 0; z-index: 100000; background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s ease;
        }
        #guide-mask.active { opacity: 1; pointer-events: auto; }
        .guide-content { text-align: center; width: 85%; max-width: 320px; }
        .guide-ok-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; padding: 12px 60px; border-radius: 30px; font-size: 11px; 
            letter-spacing: 2px; cursor: pointer; margin-top: 40px; transition: 0.3s;
        }

        .page-container { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; transition: opacity 0.6s ease; }

        /* 1. Portal 传送门 */
        .kinetic-shape { width: 80px; height: 80px; border: 1.5px solid #fff; cursor: pointer; animation: kineticFlow 4s infinite both; }
        @keyframes kineticFlow { 0%, 30% { width: 80px; height: 80px; } 45%, 75% { width: 24px; height: 120px; } 100% { width: 80px; height: 80px; } }

        /* 2. Selection 选择区 */
        #selection-page { display: none; opacity: 0; z-index: 10000; }
        .spectrum-container { display: flex; gap: 40px; align-items: center; }
        .color-pillar { 
            width: 24px; height: 120px; border: 1.5px solid currentColor; 
            cursor: pointer; transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
            filter: saturate(0.2) opacity(0.4);
        }
        .color-pillar.red { filter: saturate(1) opacity(1); }
        .color-pillar.fully-active { filter: saturate(1) opacity(1); }
        .color-pillar:hover { transform: scale(1.2); filter: saturate(1.2) opacity(1); }
        .color-pillar.filled { background: currentColor; }

        .red { color: #ff4d4d; } .orange { color: #ff944d; } .yellow { color: #ffd14d; }
        .green { color: #4dff88; } .blue { color: #4d94ff; } .purple { color: #944dff; }

        /* 3. Setup UI */
        #setup-layer { display: none; opacity: 0; z-index: 20000; }
        .setup-card { 
            width: 85%; max-width: 350px; padding: 40px; border-radius: 35px; 
            border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.03); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        .setup-card h2 { font-size: 16px; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; color: #fff; }
        .setup-card label { font-size: 9px; opacity: 0.4; display: block; margin-bottom: 10px; text-align: left; letter-spacing: 1px; }
        .setup-card input, .setup-card textarea {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            padding: 12px; color: #fff; border-radius: 12px; margin-bottom: 25px; outline: none; font-family: inherit;
        }
        .save-btn { width: 100%; padding: 18px; border: none; border-radius: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; color: #fff; }

        /* 4. Main Display */
        #main-display { display: none; opacity: 0; z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
        .bg-glass { position: absolute; inset: 0; z-index: -1; background-size: cover; background-position: center; filter: blur(100px) brightness(0.3); transform: scale(1.5); }
        
        .nav-header { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 6000; }
        .back-btn { 
            background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); 
            padding: 12px 30px; border-radius: 30px; font-size: 11px; font-weight: 600; 
            letter-spacing: 1px; cursor: pointer; backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); transition: 0.3s; text-transform: uppercase;
        }
        .back-btn:hover { background: rgba(255,255,255,0.9); color: #000; }

        .main-avatar-display { 
            width: 270px; height: 270px; border-radius: 50%; 
            background: rgba(255,255,255,0.02); overflow: hidden; 
            border: 2px solid transparent; 
            box-shadow: 0 30px 80px rgba(0,0,0,0.5); 
            margin-bottom: 40px; 
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .main-avatar-display img { width: 100%; height: 100%; object-fit: cover; }

        .hero-text-block { text-align: center; width: 100%; padding: 0 30px; }
        .hero-text-block h1 { font-size: 26px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
        .hero-text-block .time-stamp { font-size: 12px; opacity: 0.4; letter-spacing: 2px; display: block; margin-bottom: 20px; }
        .hero-text-block .description { font-size: 14px; font-weight: 300; line-height: 1.8; max-width: 300px; margin: 0 auto; opacity: 0.7; }
    </style>
</head>
<body>

    <button id="global-reset" onclick="resetSystem()">SYSTEM RESET</button>

    <div id="guide-mask">
        <div class="guide-content">
            <p id="guide-text-content" style="font-weight: 200;"></p>
            <button class="guide-ok-btn" onclick="closeGuide()">OK</button>
        </div>
    </div>

    <div id="tutorial-overlay" class="page-container">
        <div class="kinetic-shape" onclick="finishGuide()"></div>
    </div>

    <div id="selection-page" class="page-container">
        <div class="spectrum-container">
            <div id="pillar-red" class="color-pillar red" onclick="handlePillarClick('red')"></div>
            <div id="pillar-orange" class="color-pillar orange" onclick="handlePillarClick('orange')"></div>
            <div id="pillar-yellow" class="color-pillar yellow" onclick="handlePillarClick('yellow')"></div>
            <div id="pillar-green" class="color-pillar green" onclick="handlePillarClick('green')"></div>
            <div id="pillar-blue" class="color-pillar blue" onclick="handlePillarClick('blue')"></div>
            <div id="pillar-purple" class="color-pillar purple" onclick="handlePillarClick('purple')"></div>
        </div>
    </div>

    <div id="setup-layer" class="page-container">
        <div class="setup-card">
            <h2 id="setup-title">Something important to you...</h2>
            <label>OBJECT IMAGE</label>
            <input type="file" id="up-img">
            <label>NAME</label>
            <input type="text" id="up-name" placeholder="Sample Name">
            <label>HISTORY / DESCRIPTION</label>
            <textarea id="up-desc" rows="3" placeholder="Tell the story..."></textarea>
            <button id="save-btn" class="save-btn" onclick="saveData()">Save the object</button>
        </div>
    </div>

    <div id="main-display" class="page-container">
        <div class="bg-glass" id="hero-bg"></div>
        <div class="nav-header">
            <button class="back-btn" onclick="returnToBox()">BACK TO BOX</button>
        </div>

        <div class="main-avatar-display" id="avatar-container">
            <img id="hero-img" src="" style="display:none;">
            <svg id="hero-icon" style="width:60px; opacity:0.1;" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        </div>

        <div class="hero-text-block">
            <h1 id="hero-title"></h1>
            <span class="time-stamp" id="hero-date"></span>
            <p class="description" id="hero-description"></p>
        </div>
    </div>

    <script>
        /* --- Blynk 配置 --- */
        const AUTH_TOKEN  = 'OqSFS2EppKQRi0DYBOTFNEQgW7pljRjT';
        const BLYNK_HOST  = 'blynk.cloud';
        const VIRTUAL_PIN = 'V1';

        function sendToBlynk(value) {
            const url = `https://${BLYNK_HOST}/external/api/update?token=${AUTH_TOKEN}&${VIRTUAL_PIN}=${value}`;
            fetch(url).then(() => console.log(`指令 ${value} 同步成功`)).catch(err => console.error('同步失败:', err));
        }

        /* --- 系统逻辑 --- */
        const DB_KEY = 'memobox_v4_unified';
        let currentPillarColor = 'red';
        let appState = JSON.parse(localStorage.getItem(DB_KEY)) || { hasGuided: false, firstSaveDone: false, storedVaults: {} };

        const steps = {
            portal: "Welcome to M-Cube. Tap the box to start.",
            spectrum: "These are M-cards in this box. Please tap the Red to continue.",
            setup: "Here, store the story of this object.",
            complete: "Object saved!"
        };

        function triggerGuide(text) {
            setTimeout(() => {
                document.getElementById('guide-text-content').innerHTML = text;
                document.getElementById('guide-mask').classList.add('active');
            }, 1200);
        }
        function closeGuide() { document.getElementById('guide-mask').classList.remove('active'); }

        window.onload = () => {
            if (appState.hasGuided) {
                document.getElementById('tutorial-overlay').style.display = 'none';
                showSelectionPage(false); 
            } else {
                triggerGuide(steps.portal);
            }
        };

        function finishGuide() {
            appState.hasGuided = true;
            updateDB();
            document.getElementById('tutorial-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('tutorial-overlay').style.display = 'none';
                showSelectionPage(true);
            }, 400);
        }

        function showSelectionPage(withGuide) {
            const page = document.getElementById('selection-page');
            page.style.display = 'flex';

            if (!withGuide && appState.hasGuided && !appState.storedVaults['green']) {
                appState.storedVaults['green'] = {
                    name: "Lucky Bamboo",
                    desc: "Bought this the day I landed in Delft. It’s been with me through everything—the long nights of studying and all the growing up I’ve done here. it is just there, quiet and steady. Just looking at it makes my day a little brighter.",
                    img: "https://preview.redd.it/my-6-7-year-old-lucky-bamboo-v0-73dtwvzodcqe1.jpeg?width=640&crop=smart&auto=webp&s=f905e4f9b2085d49389f54f3435aad6a3ca6149d"
                };
                appState.firstSaveDone = true; 
                updateDB();
            }

            const pillars = document.querySelectorAll('.color-pillar');
            pillars.forEach(p => {
                const colorId = p.id.split('-')[1];
                if (withGuide && p.id !== 'pillar-red') {
                    p.style.pointerEvents = 'none'; p.style.opacity = '0.5';
                } else {
                    p.style.pointerEvents = 'auto'; p.style.opacity = '1';
                }
                if (appState.firstSaveDone) p.classList.add('fully-active');
                if (appState.storedVaults[colorId]) p.classList.add('filled');
            });

            setTimeout(() => { page.style.opacity = '1'; if(withGuide) triggerGuide(steps.spectrum); }, 50);
        }

        function handlePillarClick(color) {
            currentPillarColor = color;
            
            // 动作1：点击红卡触发硬件
            if (color === 'red') { sendToBlynk(1); }
            
            // 绿色跳转逻辑
            if (color === 'green' && appState.storedVaults['green']) {
                localStorage.setItem('memo_config', JSON.stringify(appState.storedVaults['green']));
                window.location.href = 'demo.html'; 
                return;
            }

            if (appState.storedVaults[color]) {
                showMainDisplay(color);
            } else {
                document.getElementById('selection-page').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('selection-page').style.display = 'none';
                    const setup = document.getElementById('setup-layer');
                    const colorMap = { red: '#ff4d4d', orange: '#ff944d', yellow: '#ffd14d', green: '#4dff88', blue: '#4d94ff', purple: '#944dff' };
                    document.getElementById('setup-title').innerText = `${color} vault`;
                    document.getElementById('setup-title').style.color = colorMap[color];
                    document.getElementById('save-btn').style.backgroundColor = colorMap[color];
                    setup.style.display = 'flex';
                    setTimeout(() => { setup.style.opacity = '1'; triggerGuide(steps.setup); }, 20);
                }, 400);
            }
        }

        function saveData() {
            const file = document.getElementById('up-img').files[0];
            const data = {
                name: document.getElementById('up-name').value || "Sample Object",
                desc: document.getElementById('up-desc').value || "This is a placeholder description.",
                img: null
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { data.img = e.target.result; finalizeSave(data); };
                reader.readAsDataURL(file);
            } else { finalizeSave(data); }
        }

        function finalizeSave(data) {
            appState.storedVaults[currentPillarColor] = data;
            appState.firstSaveDone = true;
            updateDB();
            sendToBlynk(2); // 动作2：存好后复位
            showMainDisplay(currentPillarColor, true);
        }

        function showMainDisplay(color, isFirst = false) {
            const d = appState.storedVaults[color];
            const colorMap = { red: '#ff4d4d', orange: '#ff944d', yellow: '#ffd14d', green: '#4dff88', blue: '#4d94ff', purple: '#944dff' };
            const avatarContainer = document.getElementById('avatar-container');
            avatarContainer.style.borderColor = colorMap[color];
            avatarContainer.style.boxShadow = `0 30px 80px rgba(0,0,0,0.5), 0 0 15px ${colorMap[color]}33`;

            document.getElementById('hero-title').innerText = d.name;
            document.getElementById('hero-description').innerText = d.desc;
            document.getElementById('hero-date').innerText = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
            
            const imgEl = document.getElementById('hero-img');
            const iconEl = document.getElementById('hero-icon');
            const bgEl = document.getElementById('hero-bg');

            if(d.img) {
                imgEl.src = d.img; imgEl.style.display = 'block'; iconEl.style.display = 'none';
                bgEl.style.backgroundImage = `url(${d.img})`;
            } else {
                imgEl.style.display = 'none'; iconEl.style.display = 'block';
                bgEl.style.backgroundImage = 'none'; bgEl.style.backgroundColor = '#2a2a2a';
            }

            document.getElementById('selection-page').style.display = 'none';
            document.getElementById('setup-layer').style.display = 'none';
            const main = document.getElementById('main-display');
            main.style.display = 'flex';
            setTimeout(() => { main.style.opacity = '1'; if(isFirst) triggerGuide(steps.complete); }, 50);
        }

        function returnToBox() {
            sendToBlynk(2); // 动作2：返回时复位
            document.getElementById('main-display').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('main-display').style.display = 'none';
                showSelectionPage(false);
            }, 500);
        }

        function resetSystem() {
            if(confirm("Erase all system data?")) { localStorage.removeItem(DB_KEY); location.reload(); }
        }

        function updateDB() { localStorage.setItem(DB_KEY, JSON.stringify(appState)); }
    </script>
</body>
</html>
